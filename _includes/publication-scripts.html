<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>

<style>
    /* 确保图表容器有明确高度，否则 ECharts 无法渲染 */
    .chart-container { 
        width: 100%; 
        height: 450px !important; 
        min-height: 450px;
        background-color: #fff; 
        border: 1px solid #ddd; 
        border-radius: .25rem; 
        box-shadow: 0 .125rem .25rem rgba(0,0,0,.075); 
        margin-bottom: 30px; 
        padding: 20px; 
    }
    .table-container { 
        background-color: #fff; 
        padding: 20px; 
        border-radius: .25rem; 
        box-shadow: 0 .125rem .25rem rgba(0,0,0,.075); 
        margin-bottom: 30px; 
    }
    .abstract-content { 
        max-height: 300px; 
        overflow-y: auto; 
        white-space: pre-wrap; 
        word-wrap: break-word; 
        font-size: 0.95em; 
        line-height: 1.6; 
    }
    .status-message { 
        text-align: center; 
        padding: 20px; 
        font-size: 1.2em; 
    }
    .fw-bold { color: #333; }
</style>

<script>
    // --- 多语言配置 (内嵌 DataTables 翻译以防止加载错误) ---
    const currentLang = "{{ site.active_lang | default: 'en' }}";
    const i18n = {
        zh: {
            loading: "正在同步数据...",
            noData: "未找到有效的论文数据。",
            fetchError: "无法连接到服务器，请检查数据文件路径。",
            chartYearY: "发表数量",
            chartYearX: "年份",
            tableYear: "年份",
            tableTitle: "文章标题",
            tableJournal: "发表期刊",
            tableDetails: "查看详情",
            modalTitle: "文献详细信息",
            modalAbstract: "摘要内容",
            modalClose: "关闭窗口",
            // DataTables 本地化翻译对象
            dtLanguage: {
                "processing": "处理中...",
                "lengthMenu": "显示 _MENU_ 项结果",
                "zeroRecords": "没有匹配结果",
                "info": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
                "infoEmpty": "显示第 0 至 0 项结果，共 0 项",
                "infoFiltered": "(由 _MAX_ 项结果过滤)",
                "search": "搜索:",
                "emptyTable": "表中数据为空",
                "paginate": {
                    "first": "首页",
                    "previous": "上页",
                    "next": "下页",
                    "last": "末页"
                }
            }
        },
        en: {
            loading: "Synchronizing data...",
            noData: "No valid publication data found.",
            fetchError: "Server connection failed, please check data path.",
            chartYearY: "Publications Count",
            chartYearX: "Year",
            tableYear: "Year",
            tableTitle: "Title",
            tableJournal: "Journal",
            tableDetails: "Details",
            modalTitle: "Publication Details",
            modalAbstract: "Abstract",
            modalClose: "Close",
            dtLanguage: {} // 英文使用插件默认
        }
    };

    const lang = i18n[currentLang] || i18n['en'];

    // --- 数据解析器 ---
    function parsePublicationsData(fileContent) {
        const publications = [];
        const entries = fileContent.split(/\r?\nReference Type: {2}Journal Article/);
        const actualEntries = entries.slice(1).map(entry => "Reference Type:  Journal Article\n" + entry.trim());

        actualEntries.forEach((entryText) => {
            const publication = { authors: [], title: '', year: '', journal: '', doi: '', abstract: '', url: '' };
            const lines = entryText.trim().split(/\r\n?|\n/);
            let currentMode = null;
            let buffer = [];

            lines.forEach(lineContent => {
                lineContent = lineContent.trim();
                if (!lineContent) return;

                let isNewField = false;
                const fieldPrefixes = ["Author:", "Year:", "Title:", "Journal:", "DOI:", "Abstract:", "URL:"];
                
                for (const prefix of fieldPrefixes) {
                    if (lineContent.startsWith(prefix)) {
                        isNewField = true;
                        if (currentMode === 'abstract' && buffer.length > 0) publication.abstract = buffer.join(" ").trim();
                        buffer = [];
                        if (prefix === "Abstract:") currentMode = 'abstract';
                        else {
                            currentMode = null;
                            const val = lineContent.replace(prefix, "").trim();
                            const key = prefix.slice(0, -1);
                            if(key === 'Year') publication.year = val;
                            if(key === 'Title') publication.title = val;
                            if(key === 'Journal') publication.journal = val;
                            if(key === 'URL') publication.url = val;
                            if(key === 'DOI') publication.doi = val;
                            if(key === 'Author') publication.authors = val.split(/,|and|;/).map(a => a.trim()).filter(a => a);
                        }
                        break;
                    }
                }
                if (!isNewField && currentMode === 'abstract') buffer.push(lineContent);
            });
            if (publication.year && publication.title) publications.push(publication);
        });
        return publications;
    }

    // --- 图表生成器 ---
    function renderYearChart(data) {
        const chartDom = document.getElementById('publicationsByYearChart');
        if (!chartDom) return;

        const myChart = echarts.init(chartDom);
        const yearsCount = data.reduce((acc, pub) => {
            const y = pub.year.trim();
            if (/^\d{4}$/.test(y)) acc[y] = (acc[y] || 0) + 1;
            return acc;
        }, {});
        
        const sortedYears = Object.keys(yearsCount).sort();
        
        const option = {
            tooltip: { trigger: 'axis' },
            grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
            xAxis: { type: 'category', data: sortedYears, name: lang.chartYearX },
            yAxis: { type: 'value', name: lang.chartYearY },
            series: [{
                name: lang.chartYearY,
                type: 'bar',
                data: sortedYears.map(y => yearsCount[y]),
                itemStyle: { color: '#ee5a24' },
                label: { show: true, position: 'top' }
            }]
        };

        myChart.setOption(option);
        window.addEventListener('resize', () => myChart.resize());
    }

    // --- 页面初始化 ---
    $(document).ready(function() {
        const statusDiv = $('#statusMessage');
        statusDiv.text(lang.loading).show();

        $.get('{{ site.baseurl }}/assets/data/xinlab-publications.txt')
            .done(function(rawData) {
                const parsedData = parsePublicationsData(rawData);
                window.publicationData = parsedData; // 挂载到全局变量

                if (parsedData.length > 0) {
                    statusDiv.hide();
                    
                    // 1. 初始化 DataTables (直接使用内嵌语言包)
                    $('#publicationsTable').DataTable({
                        data: parsedData,
                        columns: [
                            { data: 'year', title: lang.tableYear },
                            { data: 'title', title: lang.tableTitle },
                            { 
                                data: 'journal', 
                                title: lang.tableJournal,
                                render: (d, t, r) => r.url ? `<a href="${r.url}" target="_blank">${d}</a>` : d
                            },
                            {
                                data: null,
                                title: lang.tableDetails,
                                orderable: false,
                                render: (d, t, r, meta) => `<button class="btn btn-primary btn-sm details-btn" data-index="${meta.row}">${lang.tableDetails}</button>`
                            }
                        ],
                        order: [[0, 'desc']],
                        language: lang.dtLanguage // 使用内嵌对象，解决 i18n 加载错误
                    });

                    // 2. 渲染图表
                    if (typeof echarts !== 'undefined') {
                        renderYearChart(parsedData);
                    }
                } else {
                    statusDiv.text(lang.noData).addClass("alert-danger");
                }
            })
            .fail(function() {
                statusDiv.text(lang.fetchError).addClass("alert-danger");
            });

        // 3. 详情弹窗逻辑 (使用委派确保兼容性)
        $('#publicationsTable').on('click', '.details-btn', function() {
            const index = $(this).data('index');
            const pub = window.publicationData[index];

            $('#modalTitle').text(pub.title);
            $('#modalAuthors').text(pub.authors.join(', '));
            $('#modalJournal').text(pub.journal);
            $('#modalYear').text(pub.year);
            $('#modalAbstract').text(pub.abstract || 'N/A');
            
            $('#detailsModalLabel').text(lang.modalTitle);
            $('.btn-secondary[data-bs-dismiss="modal"]').text(lang.modalClose);
            
            if (pub.doi) {
                const doiUrl = `https://doi.org/${pub.doi}`;
                $('#modalDOI').text(doiUrl).attr('href', doiUrl);
            } else {
                $('#modalDOI').text('N/A').removeAttr('href');
            }
            
            const modalEl = document.getElementById('detailsModal');
            const modalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
            modalInstance.show();
        });
    });
</script>

<div id="statusMessage" class="status-message alert"></div>

<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="container-fluid">
                    <div class="row mb-3"><div class="col-md-3 fw-bold">Title:</div><div class="col-md-9" id="modalTitle"></div></div>
                    <div class="row mb-3"><div class="col-md-3 fw-bold">Authors:</div><div class="col-md-9" id="modalAuthors"></div></div>
                    <div class="row mb-3"><div class="col-md-3 fw-bold">Journal:</div><div class="col-md-9" id="modalJournal"></div></div>
                    <div class="row mb-3"><div class="col-md-3 fw-bold">Year:</div><div class="col-md-9" id="modalYear"></div></div>
                    <div class="row mb-3"><div class="col-md-3 fw-bold">Abstract:</div><div class="col-md-9 abstract-content" id="modalAbstract"></div></div>
                    <div class="row mb-3"><div class="col-md-3 fw-bold">DOI:</div><div class="col-md-9"><a id="modalDOI" target="_blank"></a></div></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"></button>
            </div>
        </div>
    </div>
</div>